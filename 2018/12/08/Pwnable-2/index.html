<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="CVE Binary PWN hacker web security angr rex ida hack code python github hexo"><title>Pwnable（二） | Mr.Ma3k4H3d</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Pwnable（二）</h1><a id="logo" href="/.">Mr.Ma3k4H3d</a><p class="description">竹杖芒鞋轻胜马，一蓑烟雨任平生。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="https://micro8.github.io/Micro8-HTML/"><i class="fa fa-archive"> Micro8</i></a><a href="https://ma3k4h3d.top/Papers/"><i class="fa fa-archive"> Papers</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="https://book.douban.com/annual/2018?source=navigation"><i class="fa fa-archive"> 好书精选</i></a><a href="/history/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Pwnable（二）</h1><div class="post-meta">Dec 8, 2018<span> | </span><span class="category"><a href="/categories/PWN/">PWN</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 951</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 3</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>本文为 pwnable.kr 第五关 passcode 的 writeup。题目中主要涉及变量未初始化、格式化字符串与GOT表覆写三个知识点，变量未初始化与格式化字符串造成 <a href="https://rootkits.xyz/blog/2017/09/kernel-write-what-where/" target="_blank" rel="noopener">WRITE_WHAT_WHERE</a>，结合GOT表覆写，最终获取到 Flag。<br><a id="more"></a></p>
<h2 id="0x00-背景知识"><a href="#0x00-背景知识" class="headerlink" title="0x00 背景知识"></a>0x00 背景知识</h2><p>本节仅简要介绍 GOT/PLT 基本概念，详细内容可自行查阅，其中涉及的 ELF 文件格式可参考<a href="http://flint.cs.yale.edu/cs422/doc/ELF_Format.pdf" target="_blank" rel="noopener">《ELF_Format》</a>。</p>
<p><strong>GOT（Global Offset Table）：</strong>GOT 位于 .got.plt section 中，用以记录 ELF 文件中所用到的共享库中符号的绝对地址。程序初始化时，GOT 表项为空，当符号被首次调用时会动态解析对应地址，并将该地址保存在 GOT 中，之后再次调用该符号时，无需解析，直接跳转至 GOT 表中所保存的地址。</p>
<p><strong>PLT（Procedure Linkage Table）：</strong>PLT 位于 .plt section 中，用以将位置无关的符号转移到绝对地址。当一个外部符号被调用时，PLT 去引用 GOT 中的其符号对应的绝对地址，然后转入并执行。</p>
<p>当前的操作系统一般都支持 NX 特性，通常情况下 PLT 具有可执行权限(X)，没有写(W)权限；GOT 具有写权限，却不可执行。这是由于链接器运行时填充的区域，必须是可写的，但可写的区域一般不可执行，对于外部函数来说需要引入一个可执行的区域作为引导，这就是PLT的作用。同时，这也是将 PLT 与 GOT 分开的原因。下图展示了 GOT 表中存有对应符号地址时的寻址过程。<br><img src="/2018/12/08/Pwnable-2/GOT:PLT.png" alt=""></p>
<h2 id="0x01-变量未初始化"><a href="#0x01-变量未初始化" class="headerlink" title="0x01 变量未初始化"></a>0x01 变量未初始化</h2><p><img src="/2018/12/08/Pwnable-2/first.png" alt=""></p>
<p>登录服务器后查看当前目录，共有 passcode.c、passcode、flag 三个文件。尝试读取 flag 内容，提示权限不够。执行 passcode，产生段错误。<br>  <img src="/2018/12/08/Pwnable-2/ls-crash.png" alt=""></p>
<p>查看 passcode.c 文件，发现 login() 函数中的局部变量未初始化，且 main() 函数中 welcome() 与 login() 连续调用，推测两函数 ebp 相同。<br><img src="/2018/12/08/Pwnable-2/code1.png" alt=""></p>
<p>  利用 GDB 对 passcode 进行调试，输入 120 个 ’A‘，由于代码中对输入长度进行了限制，因此 welcome() 函数中的 scanf() 仅接收 100 个字节。此时栈内数据如图所示。<br>  <img src="/2018/12/08/Pwnable-2/welcome.jpg" alt=""></p>
<p>  继续调试，跟进 login() 函数，查看栈布局，发现 24 个字节被 ’A‘ 污染。对比 login() 汇编代码与源代码，分析后可知，通过构造 welcome() 函数中的输入数据，可实现对 login() 函数中 passcode1 变量中所存储内容的完全控制。<br>  <img src="/2018/12/08/Pwnable-2/debug-login.png" alt=""></p>
<h2 id="0x02-scanf"><a href="#0x02-scanf" class="headerlink" title="0x02 scanf()"></a>0x02 scanf()</h2><p>再次检查 passcode.c 文件，发现 scanf() 第二个参数缺少 &amp;。<br><img src="/2018/12/08/Pwnable-2/code2.png" alt=""><br>查看对应汇编代码，其中取地址时使用了 mov 而非 lea 指令，这使得scanf()产生内存写入漏洞。<br><img src="/2018/12/08/Pwnable-2/disas-scanf.png" alt=""><br>至此，利用变量未初始化与 scanf() ，已可实现 WRITE_WHAT_WHERE。</p>
<h2 id="0x03-GOT-覆写"><a href="#0x03-GOT-覆写" class="headerlink" title="0x03 GOT 覆写"></a>0x03 GOT 覆写</h2><p>查看 passcode 开启的安全选项，RELRO 选项为”Partial RELRO“，意味着可以采用GOT表覆写技术实现攻击。<br><img src="/2018/12/08/Pwnable-2/checksec.png" alt="">  </p>
<p>查看 section 信息，发现 GOT 具有写权限。<br><img src="/2018/12/08/Pwnable-2/readelf.png" alt=""></p>
<p>至此，思路已清晰，将passcode1 中所存储的内容布局为随后将会调用的 fflush() 函数地址，并在调用到 scanf(“%d”, passcode1) 时输入 passcode 中调用 system(“/bin/cat flag”) 时的地址即可。<br><img src="/2018/12/08/Pwnable-2/code4.png" alt=""></p>
<p>程序没有开启 PIE，无需 leak，通过 GOT 表获取到 fflush() 地址 “0x0804a004”。</p>
<p><img src="/2018/12/08/Pwnable-2/got.png" alt=""></p>
<p> 获取 passcode 中调用 system(“/bin/cat flag”) 时的地址，“0x080485e3”<br><img src="/2018/12/08/Pwnable-2/login.png" alt=""></p>
<p>(0x080485e3==134514147)<br><img src="/2018/12/08/Pwnable-2/cal.png" alt=""></p>
<p>构造exp如下并成功获取到 flag：  </p>
<p><code>python -c &quot;print 96*&#39;A&#39;+&#39;\x04\xa0\x04\x08&#39;+&#39;134514147&#39;&quot; | ./passcode”</code></p>
<p><img src="/2018/12/08/Pwnable-2/flag.jpg" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://rickgray.me/2015/08/07/use-gdb-to-study-got-and-plt/" target="_blank" rel="noopener">《通过 GDB 调试理解 GOT/PLT》</a><br><a href="https://blog.csdn.net/anzhsoft/article/details/18776111" target="_blank" rel="noopener">《Linux Debugging（七）: 使用反汇编理解动态库函数调用方式GOT/PLT》</a><br><a href="https://www.cnblogs.com/pannengzhi/p/2018-04-09-about-got-plt.html" target="_blank" rel="noopener">《深入了解GOT,PLT和动态链接》</a><br><a href="https://pediy.com/thread-205334.htm" target="_blank" rel="noopener">《利用got表pwn学习》</a><br><a href="https://r00tk1ts.github.io/2018/03/05/Pwnable-2/" target="_blank" rel="noopener">《Writeup.pwnable.kr系列之passcode》</a><br><a href="https://www.nrjfl0w.org/index.php/2016/09/04/passcode-writeup-pwnable/" target="_blank" rel="noopener">《[Pwnable.kr] passcode writeup – Toddler’s bottle》</a><br><a href="http://xhyumiracle.com/pwnable-kr-Pwnable-2/" target="_blank" rel="noopener">《Pwnable.kr - passcode》</a></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Mr.Ma3k4H3d</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2018/12/08/Pwnable-2/">http://maskhed.github.io/2018/12/08/Pwnable-2/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 CN 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/12/14/Pwnable-3/">Pwnable（三）</a><a class="next" href="/2018/12/07/Pwnable-1/">Pwnable（一）</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script>var gitalk = new Gitalk({
  clientID: '5a30c862e87dbcdd2992',
  clientSecret: 'e098ba3d824802e68648008f80b024617bd8a546',
  repo: 'ma3k4h3d.github.io',
  owner: 'Ma3k4H3d',
  admin: ['Ma3k4H3d'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AEG/">AEG</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angr/">Angr</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔杂谈/">随笔杂谈</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/CGC/" style="font-size: 15px;">CGC</a> <a href="/tags/CVE/" style="font-size: 15px;">CVE</a> <a href="/tags/Mr-Robot/" style="font-size: 15px;">Mr.Robot</a> <a href="/tags/SS/" style="font-size: 15px;">SS</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Fuzz/" style="font-size: 15px;">Fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/08/风雨兼程/">即使风雨兼程，也能守得云开见月明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/CVE-2003-0947/">iwconfig 缓冲区溢出分析及复现（CVE-2003-0947）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/PPT-test/">Baab through automatic exploit generation</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/rex-crash/">Rex：源码分析 -- Crash Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/Rex-stacksmash/">Rex AEG：栈溢出之 Exploit 自动生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/insomnihack-aeg/">angr AEG：缓冲区溢出之 Exploit 自动生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/Vulnerability-Analysis-Method/">软件漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/Pwnable-3/">Pwnable（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/08/Pwnable-2/">Pwnable（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Pwnable-1/">Pwnable（一）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.t00ls.net/" title="T00ls" target="_blank">T00ls</a><ul></ul><a href="http://riusksk.me" title="riusksk" target="_blank">riusksk</a><ul></ul><a href="https://micropoor.blogspot.com" title="Micropoor" target="_blank">Micropoor</a><ul></ul><a href="http://www.cnblogs.com/backlion" title="Backlion" target="_blank">Backlion</a><ul></ul><a href="https://onebugman.com" title="OneBugMan" target="_blank">OneBugMan</a><ul></ul><a href="http://yama0xff.com" title="yama0xff.com" target="_blank">yama0xff.com</a><ul></ul><a href="https://musicforprogramming.net" title="musicforprogramming.net" target="_blank">musicforprogramming.net</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div>Total<span id="busuanzi_container_site_pv"><span> </span><span id="busuanzi_value_site_pv"></span></span><span rel="nofollow">  hits, </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span><span rel="nofollow">  visitors. </span></div><div><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1275288791'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1275288791%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div>Copyright © 2019 <a href="/." rel="nofollow">Mr.Ma3k4H3d.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="208,55,66" opacity="0.3" zindex="-1" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>