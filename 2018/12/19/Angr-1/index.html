<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="CVE Binary PWN hacker web security angr rex ida hack code python github hexo"><title>Part 1： Angr Internals | Mr.Ma3k4H3d</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Part 1： Angr Internals</h1><a id="logo" href="/.">Mr.Ma3k4H3d</a><p class="description">想要把自己活成一场梦，一首歌，一部电影~</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-user"> 历史</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Part 1： Angr Internals</h1><div class="post-meta">Dec 19, 2018<span> | </span><span class="category"><a href="/categories/Angr/">Angr</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.1k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" href="/2018/12/19/Angr-1/#vcomment"><span class="valine-comment-count" data-xid="/2018/12/19/Angr-1/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#The-angr-lifecycle"><span class="toc-number">1.</span> <span class="toc-text">The angr lifecycle</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CLE-the-loader"><span class="toc-number">1.1.</span> <span class="toc-text">CLE, the loader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Archinfo-the-architecture-DB"><span class="toc-number">1.2.</span> <span class="toc-text">Archinfo, the architecture DB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SimEngine-the-simulated-executer"><span class="toc-number">1.3.</span> <span class="toc-text">SimEngine, the simulated executer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PyVEX-the-lifter"><span class="toc-number">1.4.</span> <span class="toc-text">PyVEX, the lifter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Claripy-the-solver"><span class="toc-number">1.5.</span> <span class="toc-text">Claripy, the solver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SimOS-the-rest-of-the-nasty-bits"><span class="toc-number">1.6.</span> <span class="toc-text">SimOS, the rest of the nasty bits</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#angr-the-real-deal"><span class="toc-number">2.</span> <span class="toc-text">angr, the real deal</span></a></li></ol></div></div><div class="post-content"><p>Angr is the popular framework for analyzing binary programs, from embedded firmware, to hardcore CTF challenges, all from the comfort of Python. angr’s roots lie in the Valgrind VEX instrumentation framework, meaning it benefits from the multi-architecture support and community maintenance. However, we live in a big world full of crazy things that aren’t Intel or ARM-based Linux machines.</p>
<a id="more"></a>
<p>angr now supports extensions to each of its core components: the loader, architecture database, lifter, execution engine, and simulated OS layer. We will be exploring each in turn, with the goal of bringing the complete suite of powerful angr analyses to bear on a totally new class of program that it was not designed to before.</p>
<p>In order to not overcomplicate things, and make the core ideas clear, we’re going to start with something conceptually simple. First, let’s go over the components themselves, and how they fit together.</p>
<h1 id="The-angr-lifecycle"><a href="#The-angr-lifecycle" class="headerlink" title="The angr lifecycle"></a>The angr lifecycle</h1><p>If you’ve used angr before, you’ve probably done this: (blatantly stolen from <a href="https://github.com/angr/angr-doc/tree/master/examples/fauxware" target="_blank" rel="noopener">angr-doc’s fauxware example</a>)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">p = angr.Project(<span class="string">"crackme"</span>)</span><br><span class="line">state = p.factory.entry_state()</span><br><span class="line">sm = p.factory.simgr(state)</span><br><span class="line">sm.step(until=<span class="keyword">lambda</span> lpg: len(lpg.active) &gt; <span class="number">1</span>)</span><br><span class="line">input_0 = sm.active[<span class="number">0</span>].posix.dumps(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>That’s only a few lines, but there’s a whole lot going on here. In that little snippet, we load a binary, lift it from machine-code to an intermediate representation that we can reason about a bit more mathematically (VEX, by default), execute representation symbolically, and finally, print the input we needed to give the program to get to the first real branch, computed using a SMT-solver.</p>
<p><strong>the angr lifecycle:</strong><br><img src="/2018/12/19/Angr-1/angr_diagram.png" alt=""></p>
<h2 id="CLE-the-loader"><a href="#CLE-the-loader" class="headerlink" title="CLE, the loader"></a>CLE, the loader</h2><p>The first thing that happens when you create an angr project is angr has to figure out what the heck you just told it to load. For this, it turns to the loader, CLE (CLE Loads Everythig) to come up with an educated guess, extract the executable code and data from whatever format it’s in, take a guess as what architecture it’s for, and create a representation of the program’s memory map as if the real loader had been used. CLE supports a set of “backends” that service various formats, such as ELF, PE, and CGC. For the common cases, this means loading an ELF, which brings with it the complicated mess of header parsing, library resolution, and strange memory layouts you both require and expect. It also supports the exact opposite of this, pure binary blobs, with a backend that just takes the bytes and puts them in the right place in memory. The result is a Loader object, which has the memory of the main program itself (<code>Loader.main_object</code>) and any libraries.</p>
<h2 id="Archinfo-the-architecture-DB"><a href="#Archinfo-the-architecture-DB" class="headerlink" title="Archinfo, the architecture DB"></a>Archinfo, the architecture DB</h2><p>During CLE’s loading, it takes a guess as to what architecture the program is for. This is usually via either a header (as in ELFs) or some simple heuristic. Either way, it makes a guess, and uses it to fetch an <code>Arch</code> object from the <code>archinfo</code> package corresponding to it. This contains a map of the register file, bit width, usual endian-ness, and so on. Literally everything else relies on this, as you can imagine.</p>
<h2 id="SimEngine-the-simulated-executer"><a href="#SimEngine-the-simulated-executer" class="headerlink" title="SimEngine, the simulated executer"></a>SimEngine, the simulated executer</h2><p>Next, angr will locate an execution engine capable of dealing with the code it just loaded. Engines are responsible for interpreting the code in some meaningful way. Fundamentally, they take a program’s <em>state</em>– a snapshot of the registers, memory, and so on– do some thing to it, usually a basic block’s worth of instructions, and produce a set of <em>successors</em>, coresponding to all the possible program states that can be reached by executing the current block. When branches are encountered, they collect <em>constraints</em> on the state which capture the conditions needed to take each path of the branch. In aggregate, this is what gives angr its reasoning power.</p>
<h2 id="PyVEX-the-lifter"><a href="#PyVEX-the-lifter" class="headerlink" title="PyVEX, the lifter"></a>PyVEX, the lifter</h2><p>angr’s default engine, SimEngineVEX, supports many architectures, simply because it doesn’t run on their machine code directly. It uses an intermediate representation, known as VEX, which machine code is translated (<em>lifted</em>) into. As an alternative to creating your own engine for a new architecture, if it is similar enough to a “normal” PC architecture, the faster solution is to simply create a Lifter for it, allowing SimEngineVEX to take care of the rest. We will explore both Lifters and Engines in this guide.</p>
<h2 id="Claripy-the-solver"><a href="#Claripy-the-solver" class="headerlink" title="Claripy, the solver"></a>Claripy, the solver</h2><p>Every action an engine performs, even something as simple as incrementing the program counter, is not necessarily an operation on a concrete value. The value could instead be a complicated expression, that when computed on, should actually result in an even bigger expression. Creating, composing, and eventually solving these is Claripy’s job. Claripy uses a SMT-solver, currently Microsoft’s Z3, to do all of this heavy-lifting. Thankfully, we won’t need to delve into that in this series, as SMT-solving is some serious black magic.</p>
<h2 id="SimOS-the-rest-of-the-nasty-bits"><a href="#SimOS-the-rest-of-the-nasty-bits" class="headerlink" title="SimOS, the rest of the nasty bits"></a>SimOS, the rest of the nasty bits</h2><p>If we just view the engine’s work on a program from the states it provides, we’re going to have a lot of work to do to get anything useful out. Where is stdin? What the heck do I do with files? Network? Are you kidding? These higher-level abstractions are provided by the OS, and don’t exist at the bare machine level. Therefore, SimOS’ job is to provide all of that to angr, so that it can be reasoned about without all the pain of interpreting just what the fake hardware would do. Based on a guess from CLE, a SimOS is created (ex. SimLinux), which defines the OS-specific embellishments on the initial state of the program, all its system calls, and convenient symbolic summaries of what syscalls and common library functions do, known as <em>SimProcedures</em>. These make angr dramatically faster and more compatible, as symbolically executing libc itself is, to say the least, insanely painful.</p>
<h1 id="angr-the-real-deal"><a href="#angr-the-real-deal" class="headerlink" title="angr, the real deal"></a>angr, the real deal</h1><p>Finally, with a Loader, an Engine, an Arch, and a SimOS, we can get to work! All of this is packaged into a Project, and offered to the higher-level analyses, such as Control-flow Graph reconstruction, program slicing, and path-based reasoning, as in the earlier example.</p>
<p>原文链接：<a href="https://angr.io/blog/throwing_a_tantrum_part_1/" target="_blank" rel="noopener">《throwing a tantrum, part 1: angr internals》</a></p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Mr.Ma3k4H3d</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2018/12/19/Angr-1/">http://maskhed.github.io/2018/12/19/Angr-1/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 CC BY-NC-SA 3.0 CN 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/12/20/Vulnerability-Analysis-Method/">软件漏洞分析</a><a class="next" href="/2018/12/14/Pwnable-3/">Pwnable（三）</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'c83TWDMv2OITOkIl6Ns8OKOn-gzGzoHsz',
  appKey:'M0S2DqxNmklrFmf8VjUhv6WB',
  placeholder:'坚持原创技术分享，您的支持将鼓励我继续创作！',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AEG/">AEG</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angr/">Angr</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔杂谈/">随笔杂谈</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CGC/" style="font-size: 15px;">CGC</a> <a href="/tags/CVE/" style="font-size: 15px;">CVE</a> <a href="/tags/Mr-Robot/" style="font-size: 15px;">Mr.Robot</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/SS/" style="font-size: 15px;">SS</a> <a href="/tags/Vim/" style="font-size: 15px;">Vim</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Fuzz/" style="font-size: 15px;">Fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/08/风雨兼程/">即使风雨兼程，也能守得云开见月明</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/04/ReadingList/">ReadingList</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/rex-crash/">Rex：源码分析 -- Crash Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/Rex-stacksmash/">Rex：实例分析 test_linux_stacksmash()</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/insomnihack-aeg/">Insomnihack_aeg 代码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/Vulnerability-Analysis-Method/">软件漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/Angr-1/">Part 1： Angr Internals</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/Pwnable-3/">Pwnable（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/08/Pwnable-2/">Pwnable（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/Pwnable-1/">Pwnable（一）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.t00ls.net/" title="T00ls" target="_blank">T00ls</a><ul></ul><a href="http://riusksk.me" title="riusksk" target="_blank">riusksk</a><ul></ul><a href="https://micropoor.blogspot.com" title="Micropoor" target="_blank">Micropoor</a><ul></ul><a href="https://musicforprogramming.net" title="musicforprogramming.net" target="_blank">musicforprogramming.net</a><ul></ul><a href="https://github.com/maskhed/MyPapers" title="Papers" target="_blank">Papers</a><ul></ul><a href="https://onebugman.com" title="OneBugMan" target="_blank">OneBugMan</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div>Total<span id="busuanzi_container_site_pv"><span> </span><span id="busuanzi_value_site_pv"></span></span><span rel="nofollow">  hits, </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span><span rel="nofollow">  visitors. </span></div><div><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1275288791'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1275288791%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div>Copyright © 2019 <a href="/." rel="nofollow">Mr.Ma3k4H3d.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="208,55,66" opacity="0.3" zIndex="-1" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>